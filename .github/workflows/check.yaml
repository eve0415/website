name: Check

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    name: Build Check
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build website
        run: pnpm build

  lint:
    name: Lint Check
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate .dev.vars
        run: |
          echo GITHUB_PAT=test >> .dev.vars
          echo MAIL_ADDRESS=test >> .dev.vars
          echo TURNSTILE_SECRET_KEY=test >> .dev.vars

      - name: Generate types
        run: pnpm generate

      - name: Run oxlint
        run: |
          pnpm oxlint --type-aware --type-check --report-unused-disable-directives --deny-warnings --format github

  format:
    name: Format Check
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check formatting
        id: format
        run: |
          set +e
          output=$(pnpm oxfmt --check 2>&1)
          exit_code=$?
          echo "$output"

          # Parse filenames and emit annotations for each file that needs formatting
          echo "$output" | grep -E "^Would format:" | while read -r line; do
            file=$(echo "$line" | sed 's/Would format: //')
            echo "::error file=$file::File needs formatting. Run 'pnpm oxfmt' to fix."
          done

          exit $exit_code

  test:
    name: Test
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm playwright install --with-deps

      - name: Generate .dev.vars
        run: |
          echo GITHUB_PAT=test >> .dev.vars
          echo MAIL_ADDRESS=test >> .dev.vars
          echo TURNSTILE_SECRET_KEY=test >> .dev.vars

      - name: Generate types
        run: pnpm generate

      - name: Run tests
        run: pnpm test --reporter=verbose --reporter=github-actions --coverage.reporter=json-summary --coverage.reporter=json

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ github.ref_name }}
          path: coverage/
          retention-days: 7

      - name: Download base coverage
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@0bd50d53a6d7fb5cb921e607957e9cc12b4ce392
        with:
          workflow: check.yaml
          branch: ${{ github.base_ref }}
          name: coverage-${{ github.base_ref }}
          path: coverage-base/
        continue-on-error: true

      - name: Coverage Report
        if: github.event_name == 'pull_request'
        uses: davelosert/vitest-coverage-report-action@5b6122e3a819a3be7b27fc961b7faafb3bf00e4d
        with:
          json-summary-path: coverage/coverage-summary.json
          json-final-path: coverage/coverage-final.json
          json-summary-compare-path: coverage-base/coverage-summary.json
          file-coverage-mode: changes
